namespace: /gitlab

server:
  defines: runnable

  metadata:
    website: https://www.gitlab.com/
    name: Gitlab CE
    icon: https://assets.monk.io/icons/gitlab-logo-gray-stacked-rgb.png
    publisher: monk.io
    description: |
      GitLab is a web-based Git repository manager that provides source code management, continuous integration, and continuous deployment (CI/CD) capabilities.

      It allows developers to collaborate on code in a single, centralized location and includes features such as issue tracking, code review, and version control.

      GitLab offers a wide range of integrations with other development tools and platforms, making it a powerful tool for software development teams.
    source: https://github.com/gitlabhq/gitlabhq
    tags: git, gitlab, source control, repository, runner, server

  # volumes:
  #   defines: volumes
  #   gitlab-data:
  #     size: 200
  #     kind: SSD
  #     path: <- `${monk-volume-path}/gitlab-data`
  #     backup:
  #       rotation-days: 5
  #       every: 1
  #       kind: day
  #       start-time: 03:00
  #       start-day: MONDAY

  variables:
    ssh-port:
      value: 23
      type: string
      env: sshPort

    gitlab-url:
      type: string
      value: <- "http://" ip-address-public concat-all
      env: gitlabUrl

    gitlab-root-password:
      type: string
      value: z123z123
      env: gitlabRootPassword

    gitlab-omnibus-config:
      type: string
      value: |
        gitlab_rails['gitlab_default_theme'] = 2
        gitlab_rails['initial_root_password'] = ENV['gitlabRootPassword']
        gitlab_rails['gitlab_shell_ssh_port'] = ENV['sshPort'].to_i
        external_url ENV['gitlabUrl']
      env: GITLAB_OMNIBUS_CONFIG

  containers:
    app:
      image: docker.io/gitlab/gitlab-ce
      paths:
      - <- `${monk-volume-path}/gitlab-data/data:/var/opt/gitlab`
      - <- `${monk-volume-path}/gitlab-data/logs:/var/log/gitlab`
      - <- `${monk-volume-path}/gitlab-data/config:/etc/gitlab`
      image-tag: latest

      ports:
      - <- `${ssh-port}:22`
      - 80:80
      - 443:443
      - 5050:5050

runner:
  defines: runnable

  metadata:
    website: https://www.gitlab.com/
    name: Gitlab CE
    icon: https://assets.monk.io/icons/gitlab-logo-gray-stacked-rgb.png
    publisher: monk.io
    description: |
      GitLab is a web-based Git repository manager that provides source code management, continuous integration, and continuous deployment (CI/CD) capabilities.

      It allows developers to collaborate on code in a single, centralized location and includes features such as issue tracking, code review, and version control.

      GitLab offers a wide range of integrations with other development tools and platforms, making it a powerful tool for software development teams.    source: https://github.com/gitlabhq/gitlabhq
    tags: git, gitlab, source control, repository, runner

  containers:
    runner:
      image: docker.io/gitlab/gitlab-runner
      image-tag: alpine

  actions:
    register:
      arguments:
        token:
          description: Gitlab registration token
          type: string
        url:
          description: Gitlab url
          type: string
      code: exec("runner", "/bin/bash", "-c", `gitlab-runner register --non-interactive
        --url ${args["url"]} --registration-token ${args["token"]}
        --executor "docker" --docker-image alpine:latest --description "docker-runner"
        --tag-list "docker,monk" --run-untagged="true" --locked="false" --access-level="not_protected"`)
      description: Register the runner with gitlab

stack:
  defines: process-group

  metadata:
    website: https://www.gitlab.com/
    name: Gitlab CE
    icon: https://assets.monk.io/icons/gitlab-logo-gray-stacked-rgb.png
    publisher: monk.io
    description: |
      GitLab is a web-based Git repository manager that provides source code management, continuous integration, and continuous deployment (CI/CD) capabilities.

      It allows developers to collaborate on code in a single, centralized location and includes features such as issue tracking, code review, and version control.

      GitLab offers a wide range of integrations with other development tools and platforms, making it a powerful tool for software development teams.
    source: https://github.com/gitlabhq/gitlabhq
    tags: git, gitlab, source control, repository, runner, server

  runnable-list:
    - gitlab/server
    - gitlab/runner
